(function(a){a.fn.uploadify=function(m){var n='<div id="${fileID}" class="uploadify-queue-item "><div class="uploadify-progress"><div class="uploadify-progress-bar"></div></div><span class="up_filename">${fileName}</span><span class="uploadbtn">上传</span><span class="delfilebtn">删除</span></div>';var j={fileTypeExts:"",uploader:"",auto:false,method:"post",multi:false,formData:{},fileObjName:"filedata",fileSizeLimit:2048,showUploadedPercent:true,showUploadedSize:false,buttonText:"",isDefinedButton:false,isOrnotButton:false,removeTimeout:1000,itemTemplate:n,breakPoints:false,fileSplitSize:1024*1024,getFileSizeUrl:"",getFileSizeUrlFlag:true,view_progress:null,getUploadedSize:function b(u){if(l.getFileSizeUrlFlag){var t=0;a.ajax({url:l.getFileSizeUrl,async:false,type:"post",dataType:"json",data:{fileMd5:u.md5,fileSplitSize:l.fileSplitSize,fileName:u.name,totalSize:u.size},success:function(v){if(v.success){t=v.size}else{t=-1;Mobi.ing(v.msg)}}});return t}},saveUploadedSize:null,saveInfoLocal:false,onUploadStart:null,onUploadSuccess:null,onUploadComplete:null,onUploadError:null,onInit:null,onCancel:null,onSelect:null};var l=a.extend(j,m);var q=function(t){l.uploader=t};var h=function(t,u){if(t>1024*1024&&!u){t=(Math.round(t*100/(1024*1024))/100).toString()+"MB"}else{t=(Math.round(t*100/1024)/100).toString()+"KB"}return t};var i=function(t,v){for(var u=0;u<v.length;u++){if(v[u].index==t){return v[u]}}return false};var e=function(x){var u=[];var v=x.split(";");for(var w=0,t=v.length;w<t;w++){u.unshift(v[w].split(".").pop())}return u};var s={img:["image/*"],zip:["application/x-zip-compressed"],doc:["application/msword"],xls:["application/msexcel"],docx:["application/vnd.openxmlformats-officedocument.wordprocessingml.document"],xlsx:["application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"],ppt:["application/vnd.ms-powerpoint"],pptx:["application/vnd.openxmlformats-officedocument.presentationml.presentation"],mp3:["audio/mp3"],mp4:["video/mp4"],pdf:["application/pdf"],exe:["application/x-msdownload"],html:["text/html"],ico:["image/x-icon"],txt:["text/plain"],flv:[".flv"],swf:["application/x-shockwave-flash"],jpg:["image/jpg"],jpeg:["image/jpeg"],png:["image/png"],gif:["image/gif"],bmp:["image/bmp"]};var r=function(t){return s[t]};var d=function(A){var y=e(A);var B=[];var u=[];var v=false;for(var x=0,z=y.length;x<z;x++){var t=r(y[x]);if(t){B.push(t)}}if(B.length>0){for(var w=0;w<B.length;w++){if(B[w][0].indexOf("image")==-1){u.push(B[w])}else{v=true}}if(v){u.unshift(s.img)}}if(Mobi.isWechat()&&Mobi.isMX()){return u.join(",")}else{return B.join(",")}};var g=function(u,x,w,t){x.open(l.method,u,true);x.setRequestHeader("X-Requested-With","XMLHttpRequest");var v=new FormData();v.append(l.fileObjName,w,w.name);if(t){for(key in t){v.append(key,t[key])}}x.send(v)};var o=90;function k(u){if(u.status=="start"){var z=['<div id="progressBody_'+u.id+'" class="bodyDisable"></div>','<div id="progressWrap_'+u.id+'" class="bodyProgressWrap">','<div class="progressCenter"></div>','<div class="progressIngBody">','<div id="progressTitle'+u.id+'" class="progressIngTitle">'+u.title+"</div>",'<div class="progressIngMission">','<div class="mission"><div id="progress'+u.id+'" class="progress" style="width:1%;"></div></div>','<div id="progressNum'+u.id+'" class="progressNum">0%</div>',"</div>",'<div class="progressInfo"><span class="progressFileSize">文件大小:'+Fai.parseFileSize(u.size)+'</span><a class="progressCancel" href="javascript:uploadCancel(\''+u.id+"');\">取消</a></div>","</div>","</div>"];a("body").append(z.join(""));o=90}else{if(u.status=="ing"){var w=u.percent;l.view_progress(w);a("#progressTitle"+u.id).text(u.title);var y=p.fileFilter[0].name;var t=e(y)[0].toLowerCase();var x=r(t)==null?"":r(t)[0];if(u.percent>o&&u.percent!=100){var v=Math.random()/5;o+=parseFloat(v.toFixed(2));o=parseFloat(o.toFixed(2));w=o}if(x.indexOf("image")>=0){a("#progress"+u.id).css("width",w+"%");a("#progressNum"+u.id).html(w+"%")}else{a("#progress"+u.id).css("width",u.percent+"%");a("#progressNum"+u.id).html(u.percent+"%")}a("#progress"+u.id).attr("width",u.percent);if(x.indexOf("image")>=0){if(u.percent>99){c(u.id)}}}else{if(u.status=="end"){a("#progressTitle"+u.id).text(u.title);a("#progressBody_"+u.id).remove();a("#progressWrap_"+u.id).remove()}else{if(u.status=="error"){a("#progress"+u.id).addClass("progressError")}}}}}function c(t){if(o==90){return}o+=0.5;if(o>100){return}o=parseFloat(o.toFixed(2));a("#progress"+t).css("width",o+"%");a("#progressNum"+t).html(o+"%");setTimeout(function(){c(t)},1000)}var p=null;this.each(function(){var w=a(this);var t=a(".uploadify").length+1;var u='<input id="select_btn_'+t+'" class="selectbtn" style="visibility: hidden;width: 0px;height: 0px;opacity: 0;" name="fileselect[]"';u+=l.multi?" multiple":"";u+=' accept="';if(l.fileTypeExts==null||l.fileTypeExts==""||l.fileTypeExts=="*"){if(Mobi.isWechat()){u+="image/jpg,image/jpeg,image/png,image/gif,image/bmp,application/x-zip-compressed,application/msword,application/msexcel,application/vnd.openxmlformats-officedocument.wordprocessingml.document,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,application/vnd.ms-powerpoint,application/vnd.openxmlformats-officedocument.presentationml.presentation,audio/mp3,video/mp4,application/pdf,application/x-msdownload,text/html,image/x-icon,text/plain,.flv,application/x-shockwave-flash"}else{u+="*.*"}}else{u+=d(l.fileTypeExts)}u+='" type="file"/>';if(!l.isDefinedButton){u+='<a id="file_upload_'+t+'-button" href="javascript:void(0)" class="uploadify-button">';u+=l.buttonText;u+="</a>"}var v='<div id="file_upload_'+t+'-queue" class="uploadify-queue"></div>';w.append(u);p={xhr:null,uploadAllowed:true,fileInput:w.find(".selectbtn"),uploadFileList:a(document).find(".uploadify-queue"),url:l.uploader,fileFilter:[],uploadOver:false,filter:function(y){var C=[];var z=false;var F=e(l.fileTypeExts);if(l.fileTypeExts==""||l.fileTypeExts=="*.*"||l.fileTypeExts==null||d(l.fileTypeExts).indexOf("image/*")!=-1){z=true}if(F.length>0){for(var B=0,E=y.length;B<E;B++){var A=y[B];if(A.size>l.fileSizeLimit){if(l.siteFree){Mobi.ing("免费版单个文件大小不超过"+l.fileSizeLimit/1024/1024+"MB，<a href='"+l.updateUrlViewRes+'\' target="_blank">点击了解各版本限制。</a>',true)}else{Mobi.ing("单个文件超过"+l.fileSizeLimit/1024/1024+"MB",true)}continue}var x=A.name;var D=x.indexOf(".");var G="";if(D!=-1){G=x.substring(D+1)}if(l.siteFree&&G=="apk"){Mobi.ing("上传失败：您的版本目前不支持上传apk文件。",true);continue}if(!z){if(a.inArray(A.name.split(".").pop().toLowerCase(),F)>=0){C.push(A)}else{Mobi.ing("文件"+A.name+"类型不允许！",true)}}else{C.push(A)}}}return C},funSelect:function(z){if(l.onSelect&&!l.onSelect(z)){p.fileFilter=[];return}if(l.breakPoints){var A=this.funGetUploadedSize(z[0])}if(A==-1){return}var y=(A/z[0].size*100).toFixed(2);var x={status:"start",id:z[0].id,title:"准备上传.....",percent:y,size:z[0].size};k(x);if(l.breakPoints){x={status:"ing",id:z[0].id,title:"正在上传.....",percent:y};k(x);this.funUploadFile(z[0])}},onProgress:function(y,A,E){var B=a("body").find("#progressWrap_"+y.id);var F=A;var x=B.attr("lastLoaded")||0;A-=parseInt(x);if(A<0){A=0}var C=a("#progress"+y.id);var z=l.breakPoints?parseFloat(C.attr("width")):0;var D=(A/E*100+z).toFixed(2);D=D>100?99.99:D;if(F<l.fileSplitSize){B.attr("lastLoaded",F)}else{B.removeAttr("lastLoaded")}tmpoptions={status:"ing",id:y.id,title:"正在上传.....",percent:D};k(tmpoptions)},funGetProgressWidth:function(x){},funGetUploadedSize:function(x){if(l.getUploadedSize){return l.getUploadedSize(x)}else{if(l.saveInfoLocal){return parseInt(localStorage.getItem(x.name))||0}}},funSaveUploadedSize:function(x,y){if(l.saveUploadedSize){l.saveUploadedSize(x,y)}else{if(l.saveInfoLocal){localStorage.setItem(x.name,y)}}},funGetFiles:function(A){var z=A.target.files;z=this.filter(z);for(var y=0,x=z.length;y<x;y++){this.fileFilter.push(z[y])}if(this.fileFilter.length==0){return}this.funDealFiles(z);return this},funDealFiles:function(z){var A=a(document).find(".uploadify-queue .uploadify-queue-item").length;for(var y=0,x=z.length;y<x;y++){z[y].index=++A;z[y].id="fileupload_"+t+"_"+z[y].index;z[y].md5=a.md5(z[y].name+z[y].size+z[y].type+z[y].lastModifiedDate.getTime());if(z[y].size>=0&&z[y].size<20<<10<<10){l.fileSplitSize=5<<10<<10}else{if(z[y].size>=20<<10<<10&&z[y].size<50<<10<<10){l.fileSplitSize=5<<10<<10}else{if(z[y].size>=50<<10<<10&&z[y].size<100<<10<<10){l.fileSplitSize=8<<10<<10}else{if(z[y].size>=100<<10<<10&&z[y].size<500<<10<<10){l.fileSplitSize=10<<10<<10}else{l.fileSplitSize=15<<10<<10}}}}}this.funSelect(z);return this},funDeleteFile:function(y){for(var A=0,x=this.fileFilter.length;A<x;A++){var z=this.fileFilter[A];if(z.index==y){if(l.breakPoints){this.uploadAllowed=false}this.fileFilter.splice(A,1);p.fileInput.val("");l.onCancel&&l.onCancel(z);break}}return this},funUploadFile:function(C){p.xhr=new XMLHttpRequest();var J=C;var z=false;var x=a(document).find("#fileupload_"+t+"_"+C.index);var G=function(){if(p.uploadOver){x.find(".uploadify-progress-bar").css("width","100%");l.showUploadedSize&&x.find(".uploadedsize").text(x.find(".totalsize").text());l.showUploadedPercent&&x.find(".up_percent").text("100%");l.onUploadSuccess&&l.onUploadSuccess(J,p.xhr.responseText);p.funDeleteFile(C.index);setTimeout(H,1500)}};var H=function(){if(p.fileFilter.length!=0){var M=p.funGetUploadedSize(p.fileFilter[0]);var L=(M/p.fileFilter[0].size*100);var K={status:"start",id:p.fileFilter[0].id,title:"准备上传.....",percent:L,size:p.fileFilter[0].size};k(K);K={status:"ing",id:p.fileFilter[0].id,title:"正在上传.....",percent:L};k(K);p.funUploadFile(p.fileFilter[0])}};try{p.xhr=new XMLHttpRequest()}catch(I){p.xhr=ActiveXobject("Msxml12.XMLHTTP")}if(l.breakPoints){var E=C.name,B=C.id,A=C.index,D=C.size,F=C.md5;var y=parseInt(this.funGetUploadedSize(J));if(D>=l.fileSplitSize){C=J.slice(y,y+l.fileSplitSize);z=false;p.lastSplit=false}else{z=true;p.lastSplit=true}C.name=E;C.id=B;C.index=A;C.md5=F}if(p.xhr.upload&&y!==false){p.xhr.upload.addEventListener("progress",function(K){p.onProgress(C,K.loaded,J.size)},false);p.xhr.onreadystatechange=function(){if(p.xhr.readyState==4){p.uploadOver=true;if(p.xhr.status==200){var L=JSON.parse(p.xhr.responseText);if(L.success){if(l.breakPoints){y+=l.fileSplitSize;p.funSaveUploadedSize(J,y>=D?D:y);if(y<D){p.uploadOver=false;if(p.uploadAllowed){if((y+l.fileSplitSize)>=D){C=J.slice(y,D);z=true}else{C=J.slice(y,y+l.fileSplitSize);z=false}C.name=E;C.id=B;C.index=A;C.size=D;l.formData.fileMd5=J.md5;l.formData.totalSize=J.size;l.formData.complete=z;l.formData.initSize=y;setTimeout(g(p.url,p.xhr,C,l.formData),2000)}}else{G()}}else{G()}}else{Mobi.ing("文件："+C.name+"  "+L.msg,true);var K={status:"end",id:C.id};k(K);p.uploadOver=true;G()}}else{p.uploadOver&&l.onUploadError&&l.onUploadError(J,p.xhr.responseText)}if(p.uploadOver){l.onUploadComplete&&l.onUploadComplete(J,p.xhr.responseText);p.fileInput.val("");o=90}}};l.onUploadStart&&l.onUploadStart(C);l.formData.fileMd5=C.md5;l.formData.totalSize=J.size;l.formData.complete=z;l.formData.initSize=y;p.uploadAllowed=true;f(l.post_params);g(p.url,p.xhr,C,l.formData)}},init:function(){if(this.fileInput.length>0){this.fileInput.change(function(x){p.funGetFiles(x)})}w.find(".uploadify-button").on("click",function(){w.find(".selectbtn").trigger("click")});l.onInit&&l.onInit()}};p.init()});function f(u){var t=l.uploader;for(key in u){t+="&"+key+"="+u[key]}p.url=t}Fai.parseFileSize=function(v){if(typeof v!="undefined"&&typeof v=="number"){var u;if(v<1024){u=v+"B"}else{if(v<1024*1024){var t=v/1024;u=t.toFixed(2)+"KB"}else{var t=v/(1024*1024);u=t.toFixed(2)+"MB"}}return u}else{return"-"}};return{genUploadUrl:f,stop:function(){p.xhr.abort();p.uploadOver=false;p.uploadAllowed=false;for(var u=0,t=p.fileFilter.length;u<t;u++){p.funDeleteFile(++u)}p.fileFilter=[]},upload:function(w){if(w==="*"){var t=t=p.fileFilter.length;for(var v=0,t=p.fileFilter.length;v<t;v++){p.funUploadFile(p.fileFilter[v])}}else{var u=i(w,p.fileFilter);u&&p.funUploadFile(u)}},cancel:function(v){v="*";if(v=="*"){for(var u=0,t=p.fileFilter.length;u<t;u++){p.funDeleteFile(++u)}}else{p.funDeleteFile(v)}},disable:function(u){var t=u?a("file_upload_"+u+"-button"):a("body");t.find(".uploadify-button").css("background-color","#888").off("click")},ennable:function(u){var t=u?a("file_upload_"+u+"-button"):a("body");t.find(".uploadify-button").css("background-color","#707070").on("click",function(){t.find(".selectbtn").trigger("click")})}}}})(jm);